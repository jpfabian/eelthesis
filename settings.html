<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - EEL</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.css" rel="stylesheet">
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>Loading Settings...</p>
        </div>
    </div>

    <!-- Main Application Layout -->
    <div id="main-app" class="flex h-screen bg-background hidden">
        <!-- Sidebar -->
        <div id="sidebar" class="w-64 bg-sidebar border-r border-sidebar-border h-full flex flex-col">
            <!-- Sidebar Header -->
            <div class="p-6">
                <h1 id="sidebar-title" class="text-xl font-semibold">EEL</h1>
                <p id="sidebar-welcome" class="text-sm text-muted-foreground mt-1">Welcome</p>
            </div>
            
            <!-- back to class Button -->
            <div class="p-4">
                <button id="back-class-btn" class="nav-button btn btn-side-bar w-full justify-start gap-3 p-3 rounded-md text-left transition-all flex items-center">
                    <i data-lucide="arrow-left" class="size-5"></i>
                    Back to Classes
                </button>
            </div>
            
            <!-- Navigation -->
            <nav id="sidebar-nav" class="flex-1 px-4 space-y-2">
                <!-- Navigation items will be populated by JavaScript -->
            </nav>

            <div class="p-4">
                <button id="logout-btn" class="w-full p-3 logout-button btn-side-bar border">
                    <i data-lucide="log-out"></i>
                    Logout
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <main id="main-content" class="flex-1 overflow-auto">
            <div class="p-6 space-y-6">
                <div>
                    <h2 class="text-2xl font-semibold mb-2">Settings</h2>
                    <p class="text-muted-foreground">Manage your account preferences and application settings</p>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="card group cursor-pointer hover:shadow-lg transition-all duration-300 hover:-translate-y-1">
                    <div class="card-header">
                        <h3 class="card-title">Profile Information</h3>
                        <p class="card-description">Update your personal information and profile details</p>
                    </div>
                    <div class="card-content space-y-4">
                        <div class="flex items-center gap-6">
                            <div class="w-24 h-24 rounded-full bg-primary/20 flex items-center justify-center">
                                <span class="text-2xl font-bold text-primary" id="profile-initials">JD</span>
                            </div>
                            <div class="flex-1 space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="space-y-2">
                                        <label class="form-label">First Name</label>
                                        <input type="text" id="first-name" class="form-input" value="">
                                    </div>
                                    <div class="space-y-2">
                                        <label class="form-label">Last Name</label>
                                        <input type="text" id="last-name" class="form-input" value="">
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <label class="form-label">Email Address</label>
                                    <input type="email" id="email" class="form-input" value="">
                                </div>
                                <div class="space-y-2" id="teacher-bio" style="display: none;">
                                    <label class="form-label">Bio</label>
                                    <textarea id="bio" class="form-textarea" rows="3" placeholder="Tell your students about yourself..."></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-end">
                            <button class="btn btn-primary" onclick="saveProfile()">
                                <i data-lucide="save" class="size-4 mr-2"></i>
                                Save Changes
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Learning Preferences (Student Only) -->
                <div class="card" id="learning-preferences" style="display: none;">
                    <div class="card-header">
                        <h3 class="card-title">Learning Preferences</h3>
                        <p class="card-description">Customize your learning experience</p>
                    </div>
                    <div class="card-content space-y-4">
                        <div class="space-y-2">
                            <label class="form-label">Preferred Difficulty Level</label>
                            <select id="difficulty-level" class="form-input">
                                <option value="beginner">Beginner</option>
                                <option value="intermediate" selected>Intermediate</option>
                                <option value="advanced">Advanced</option>
                                <option value="adaptive">Adaptive (Recommended)</option>
                            </select>
                        </div>
                        
                        <div class="space-y-2">
                            <label class="form-label">Daily Learning Goal</label>
                            <select id="daily-goal" class="form-input">
                                <option value="15">15 minutes per day</option>
                                <option value="30" selected>30 minutes per day</option>
                                <option value="45">45 minutes per day</option>
                                <option value="60">1 hour per day</option>
                            </select>
                        </div>

                        <div class="space-y-3">
                            <label class="form-label">Learning Focus Areas</label>
                            <div class="grid grid-cols-2 gap-3">
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" id="focus-reading" checked>
                                    <span>Reading Comprehension</span>
                                </label>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" id="focus-pronunciation" checked>
                                    <span>Pronunciation</span>
                                </label>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" id="focus-spelling">
                                    <span>Spelling</span>
                                </label>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" id="focus-grammar" checked>
                                    <span>Grammar</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Class Management (Teacher Only) -->
                <div class="card" id="class-management" style="display: none;">
                    <div class="card-header">
                        <h3 class="card-title">Class Management</h3>
                        <p class="card-description">Manage your classes and teaching preferences</p>
                    </div>
                    <div class="card-content space-y-4">
                        <div class="space-y-2">
                            <label class="form-label">Default Assignment Duration</label>
                            <select id="assignment-duration" class="form-input">
                                <option value="3">3 days</option>
                                <option value="7" selected>1 week</option>
                                <option value="14">2 weeks</option>
                                <option value="30">1 month</option>
                            </select>
                        </div>

                        <div class="space-y-2">
                            <label class="form-label">Auto-grading Settings</label>
                            <select id="auto-grading" class="form-input">
                                <option value="immediate" selected>Immediate feedback</option>
                                <option value="delayed">Delayed feedback (24h)</option>
                                <option value="manual">Manual grading only</option>
                            </select>
                        </div>

                        <div class="space-y-3">
                            <label class="form-label">Notification Preferences</label>
                            <div class="space-y-2">
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" id="notify-submissions" checked>
                                    <span>Student submission notifications</span>
                                </label>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" id="notify-overdue" checked>
                                    <span>Overdue assignment alerts</span>
                                </label>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" id="notify-progress">
                                    <span>Weekly progress reports</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="card group cursor-pointer hover:shadow-lg transition-all duration-300 hover:-translate-y-1">
                    <div class="card-header">
                        <h3 class="card-title">Notifications</h3>
                        <p class="card-description">Control how and when you receive notifications</p>
                    </div>
                    <div class="card-content space-y-4">
                        <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-medium">Email Notifications</h4>
                                    <p class="text-sm text-muted-foreground">Receive notifications via email</p>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="email-notifications" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>

                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-medium">Push Notifications</h4>
                                    <p class="text-sm text-muted-foreground">Receive browser notifications</p>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="push-notifications">
                                    <span class="slider"></span>
                                </label>
                            </div>

                            <div class="flex items-center justify-between" id="reminder-notifications">
                                <div>
                                    <h4 class="font-medium">Study Reminders</h4>
                                    <p class="text-sm text-muted-foreground">Daily learning reminders</p>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="study-reminders" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Privacy & Security -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Privacy & Security</h3>
                        <p class="card-description">Manage your privacy settings and account security</p>
                    </div>
                    <div class="card-content space-y-4">
                        <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-medium">Profile Visibility</h4>
                                    <p class="text-sm text-muted-foreground" id="profile-visibility-desc">Make your profile visible to other students</p>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="profile-visibility" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>

                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-medium">Data Analytics</h4>
                                    <p class="text-sm text-muted-foreground">Help improve the platform by sharing usage data</p>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="analytics" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-3">
                            <button class="btn btn-outline" onclick="changePassword()">
                                <i data-lucide="key" class="size-4 mr-2"></i>
                                Change Password
                            </button>
                        </div>
                    </div>
                </div>
            </div>

                <!-- Data Management -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Data Management</h3>
                        <p class="card-description">Export or delete your account data</p>
                    </div>
                    <div class="card-content">
                        <div class="flex flex-wrap gap-3">
                            <button class="btn btn-outline" onclick="exportData()">
                                <i data-lucide="download" class="size-4 mr-2"></i>
                                Export Data
                            </button>
                            <button class="btn btn-outline" onclick="clearCache()">
                                <i data-lucide="refresh-cw" class="size-4 mr-2"></i>
                                Clear Cache
                            </button>
                            <button class="btn btn-destructive" onclick="deleteAccount()">
                                <i data-lucide="trash" class="size-4 mr-2"></i>
                                Delete Account
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Save Changes Button -->
                <div class="flex justify-end">
                    <button class="btn btn-primary" onclick="saveAllSettings()">
                        <i data-lucide="save" class="size-4 mr-2"></i>
                        Save All Changes
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Change Password Modal -->
    <div id="password-modal" class="fixed inset-0 bg-background/80 backdrop-blur-sm z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="card w-full max-w-md">
                <div class="card-header">
                    <h3 class="card-title">Change Password</h3>
                    <button class="p-2 hover:bg-muted rounded" onclick="closePasswordModal()">
                        <i data-lucide="x" class="size-4"></i>
                    </button>
                </div>
                <div class="card-content space-y-4">
                    <div class="space-y-2">
                        <label class="form-label">Current Password</label>
                        <input type="password" id="current-password" class="form-input">
                    </div>
                    <div class="space-y-2">
                        <label class="form-label">New Password</label>
                        <input type="password" id="new-password" class="form-input">
                    </div>
                    <div class="space-y-2">
                        <label class="form-label">Confirm New Password</label>
                        <input type="password" id="confirm-password" class="form-input">
                    </div>
                    <div class="flex justify-end gap-3">
                        <button class="btn btn-outline" onclick="closePasswordModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="updatePassword()">
                            <i data-lucide="save" class="size-4 mr-2"></i>
                            Update Password
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="js/auth.js"></script>
    <script src="js/navigation.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const user = await initializePage();

                if (!user) {
                    // no user → send to login
                    window.location.href = 'login.html';
                    return;
                }

                // Set global variable
                window.currentUser = user;

                // Setup role-based UI
                setupRoleBasedSettings(user);

                // Only initialize charts if teacher
                if (user.role === 'teacher') {
                    initializeCharts();
                }

                hideLoading();

            } catch (error) {
                console.error('Error initializing page:', error);
                hideLoading();
            }
        });

        const backBtn = document.getElementById('back-class-btn');
        if (backBtn) backBtn.addEventListener('click', () => window.location.href = 'classes.html');

        function setupRoleBasedSettings(user) {
            const initials = user.name?.split(' ').map(n => n[0]).join('') ?? 'U';
            const profileInitials = document.getElementById('profile-initials');
            if (profileInitials) profileInitials.textContent = initials;

            if (user.role === 'teacher') {
                document.getElementById('teacher-bio')?.style.setProperty('display', 'block');
                document.getElementById('class-management')?.style.setProperty('display', 'block');
                document.getElementById('learning-preferences')?.style.setProperty('display', 'none');
                document.getElementById('reminder-notifications')?.style.setProperty('display', 'none');
                document.getElementById('profile-visibility-desc').textContent = 'Make your profile visible to students';
            } else {
                document.getElementById('teacher-bio')?.style.setProperty('display', 'none');
                document.getElementById('class-management')?.style.setProperty('display', 'none');
                document.getElementById('learning-preferences')?.style.setProperty('display', 'block');
                document.getElementById('reminder-notifications')?.style.setProperty('display', 'block');
                document.getElementById('profile-visibility-desc').textContent = 'Make your profile visible to other students';
            }
        }

        function saveProfile() {
            const firstName = document.getElementById('first-name').value;
            const lastName = document.getElementById('last-name').value;
            const email = document.getElementById('email').value;

            if (!firstName || !lastName || !email) {
                showNotification('Please fill in all required fields', 'warning');
                return;
            }

            // Here you would typically send the data to your backend
            showNotification('Profile updated successfully!', 'success');
        }

        function saveAllSettings() {
            // Collect all settings
            const settings = {
                profile: {
                    firstName: document.getElementById('first-name').value,
                    lastName: document.getElementById('last-name').value,
                    email: document.getElementById('email').value,
                    bio: document.getElementById('bio')?.value
                },
                notifications: {
                    email: document.getElementById('email-notifications').checked,
                    push: document.getElementById('push-notifications').checked,
                    studyReminders: document.getElementById('study-reminders')?.checked
                },
                appearance: {
                    theme: document.getElementById('theme').value,
                    language: document.getElementById('language').value,
                    fontSize: document.getElementById('font-size').value
                },
                privacy: {
                    profileVisibility: document.getElementById('profile-visibility').checked,
                    analytics: document.getElementById('analytics').checked
                }
            };

            // Add role-specific settings
            if (currentUser.role === 'student') {
                settings.learning = {
                    difficultyLevel: document.getElementById('difficulty-level').value,
                    dailyGoal: document.getElementById('daily-goal').value,
                    focusAreas: {
                        reading: document.getElementById('focus-reading').checked,
                        pronunciation: document.getElementById('focus-pronunciation').checked,
                        spelling: document.getElementById('focus-spelling').checked,
                        grammar: document.getElementById('focus-grammar').checked
                    }
                };
            } else {
                settings.teaching = {
                    assignmentDuration: document.getElementById('assignment-duration').value,
                    autoGrading: document.getElementById('auto-grading').value,
                    notifications: {
                        submissions: document.getElementById('notify-submissions').checked,
                        overdue: document.getElementById('notify-overdue').checked,
                        progress: document.getElementById('notify-progress').checked
                    }
                };
            }

            // Here you would typically send the settings to your backend
            console.log('Saving settings:', settings);
            showNotification('All settings saved successfully!', 'success');
        }

        function changePassword() {
            document.getElementById('password-modal').classList.remove('hidden');
        }

        function closePasswordModal() {
            document.getElementById('password-modal').classList.add('hidden');
            // Clear password fields
            document.getElementById('current-password').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
        }

        function updatePassword() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (!currentPassword || !newPassword || !confirmPassword) {
                showNotification('Please fill in all password fields', 'warning');
                return;
            }

            if (newPassword !== confirmPassword) {
                showNotification('New passwords do not match', 'error');
                return;
            }

            if (newPassword.length < 8) {
                showNotification('Password must be at least 8 characters long', 'warning');
                return;
            }

            // Here you would typically validate and update the password
            showNotification('Password updated successfully!', 'success');
            closePasswordModal();
        }

        function exportData() {
            showNotification('Preparing data export...', 'info');
            // Here you would implement data export functionality
        }

        function clearCache() {
            showNotification('Cache cleared successfully!', 'success');
            // Here you would implement cache clearing
        }

        function deleteAccount() {
            if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
                if (confirm('This will permanently delete all your data. Are you absolutely sure?')) {
                    showNotification('Account deletion initiated. You will receive an email confirmation.', 'warning');
                    // Here you would implement account deletion
                }
            }
        }
    </script>
</body>
</html>