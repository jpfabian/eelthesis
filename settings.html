<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - EEL</title>
    <link rel="icon" href="image/eel-character.png" type="image/png">
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.css" rel="stylesheet">
    <script src="js/theme.js"></script>
</head>
<body class="settings-page">
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>Loading Settings...</p>
        </div>
    </div>

    <!-- Main Application Layout -->
    <div id="main-app" class="flex h-screen bg-background hidden">
        <!-- Sidebar -->
        <div id="sidebar" class="w-64 bg-sidebar border-r border-sidebar-border h-full flex flex-col">
            <!-- Sidebar Header -->
            <div class="p-6">
                <h1 id="sidebar-title" class="text-xl font-semibold">EEL</h1>
                <p id="sidebar-welcome" class="text-sm text-muted-foreground mt-1">Welcome</p>
            </div>
            
            <!-- back to class Button -->
            <div class="p-4">
                <button id="back-class-btn" class="nav-button btn btn-side-bar w-full justify-start gap-3 p-3 rounded-md text-left transition-all flex items-center">
                    <i data-lucide="arrow-left" class="size-5"></i>
                    Back to Classes
                </button>
            </div>
            
            <!-- Navigation -->
            <nav id="sidebar-nav" class="flex-1 px-4 space-y-2">
                <!-- Navigation items will be populated by JavaScript -->
            </nav>

            <div class="p-4">
                <button id="logout-btn" class="w-full p-3 logout-button btn-side-bar border">
                    <i data-lucide="log-out"></i>
                    Logout
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <main id="main-content" class="flex-1 overflow-auto">
            <div class="p-6 space-y-6">
                <header class="page-header">
                    <div class="page-header-icon" aria-hidden="true">
                        <i data-lucide="settings" class="size-8"></i>
                    </div>
                    <div>
                        <h1 class="page-header-title">Settings</h1>
                        <p class="page-header-subtitle">Manage your account preferences and application settings.</p>
                    </div>
                </header>

                <div class="grid grid-cols-1 md:grid-cols-1 lg:grid-cols-1 gap-6">
                    <div class="card group cursor-pointer hover:shadow-lg transition-all duration-300 hover:-translate-y-1">
                    <div class="card-header">
                        <h3 class="card-title">Profile Information</h3>
                        <p class="card-description">Update your personal information and profile details</p>
                    </div>
                    <div class="card-content space-y-6">
                        <!-- Avatar at top (circle) -->
                        <div class="profile-avatar-top">
                            <div class="profile-avatar-container profile-avatar-circle" id="profile-avatar-container">
                                <img id="profile-avatar-img" class="profile-avatar-img hidden" alt="Profile" />
                                <span class="text-2xl font-bold text-primary" id="profile-initials">JD</span>
                            </div>
                            <div class="profile-avatar-actions flex flex-wrap gap-2 justify-center mt-3">
                                <label class="btn btn-outline btn-sm cursor-pointer mb-0">
                                    <i data-lucide="upload" class="size-4 mr-1"></i>
                                    Change avatar
                                    <input type="file" id="profile-avatar-input" accept="image/*" class="hidden" />
                                </label>
                                <button type="button" id="profile-avatar-remove" class="btn btn-outline btn-sm hidden">Remove</button>
                            </div>
                        </div>
                        <!-- Form fields below -->
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="space-y-2">
                                    <label class="form-label">First Name</label>
                                    <input type="text" id="first-name" class="form-input" value="">
                                </div>
                                <div class="space-y-2">
                                    <label class="form-label">Last Name</label>
                                    <input type="text" id="last-name" class="form-input" value="">
                                </div>
                            </div>
                            <div class="space-y-2">
                                <label class="form-label">Email Address</label>
                                <input type="email" id="email" class="form-input" value="">
                            </div>
                            <div class="space-y-2" id="teacher-bio" style="display: none;">
                                <label class="form-label">Bio</label>
                                <textarea id="bio" class="form-textarea" rows="3" placeholder="Tell your students about yourself..."></textarea>
                            </div>
                        </div>
                        <div class="flex justify-end">
                            <button class="btn btn-primary" onclick="saveProfile()">
                                <i data-lucide="save" class="size-4 mr-2"></i>
                                Save Changes
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-1 lg:grid-cols-1 gap-6">
                <!-- Privacy & Security -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Privacy & Security</h3>
                        <p class="card-description">Manage your privacy settings and account security</p>
                    </div>
                    <div class="card-content space-y-4">
                        <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-medium">Profile Visibility</h4>
                                    <p class="text-sm text-muted-foreground" id="profile-visibility-desc">Make your profile visible to other students</p>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="profile-visibility" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>

                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-medium">Data Analytics</h4>
                                    <p class="text-sm text-muted-foreground">Help improve the platform by sharing usage data</p>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="analytics" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-3">
                            <button class="btn btn-outline" onclick="changePassword()">
                                <i data-lucide="key" class="size-4 mr-2"></i>
                                Change Password
                            </button>
                            <button type="button" class="btn btn-outline" onclick="replayTutorial()">
                                <i data-lucide="play-circle" class="size-4 mr-2"></i>
                                Replay tutorial
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </main>
    </div>

    <!-- Change Password Modal -->
    <div id="password-modal" class="fixed inset-0 bg-background/80 backdrop-blur-sm z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="card w-full max-w-md">
                <div class="card-header">
                    <h3 class="card-title">Change Password</h3>
                    <button class="p-2 hover:bg-muted rounded" onclick="closePasswordModal()">
                        <i data-lucide="x" class="size-4"></i>
                    </button>
                </div>
                <div class="card-content space-y-4">
                    <div class="space-y-2">
                        <label class="form-label">Current Password</label>
                        <input type="password" id="current-password" class="form-input">
                    </div>
                    <div class="space-y-2">
                        <label class="form-label">New Password</label>
                        <input type="password" id="new-password" class="form-input">
                    </div>
                    <div class="space-y-2">
                        <label class="form-label">Confirm New Password</label>
                        <input type="password" id="confirm-password" class="form-input">
                    </div>
                    <div class="flex justify-end gap-3">
                        <button class="btn btn-outline" onclick="closePasswordModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="updatePassword()">
                            <i data-lucide="save" class="size-4 mr-2"></i>
                            Update Password
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
<script src="js-front-end/api-config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/navigation.js"></script>

    <script>
        const API_BASE = (window.API_BASE || '') + '/api';

        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const user = await initializePage();

                if (!user) {
                    window.location.href = 'login.html';
                    return;
                }

                window.currentUser = user;
                setupRoleBasedSettings(user);

                await loadProfileIntoForm(user);
                applySavedPreferences();
                applyProfileAvatar();
                setupAvatarChange();

                hideLoading();

            } catch (error) {
                console.error('Error initializing page:', error);
                hideLoading();
            }
        });

        const backBtn = document.getElementById('back-class-btn');
        if (backBtn) backBtn.addEventListener('click', () => window.location.href = 'classes.html');

        const AVATAR_STORAGE_KEY = 'eel_avatar_url';

        function applyProfileAvatar() {
            const url = localStorage.getItem(AVATAR_STORAGE_KEY);
            const img = document.getElementById('profile-avatar-img');
            const initials = document.getElementById('profile-initials');
            const removeBtn = document.getElementById('profile-avatar-remove');
            if (!img || !initials) return;
            if (url) {
                img.src = url;
                img.classList.remove('hidden');
                initials.classList.add('hidden');
                if (removeBtn) removeBtn.classList.remove('hidden');
            } else {
                img.removeAttribute('src');
                img.classList.add('hidden');
                initials.classList.remove('hidden');
                if (removeBtn) removeBtn.classList.add('hidden');
            }
        }

        function setupAvatarChange() {
            const input = document.getElementById('profile-avatar-input');
            const removeBtn = document.getElementById('profile-avatar-remove');
            if (!input) return;
            input.addEventListener('change', function() {
                const file = this.files && this.files[0];
                if (!file || !file.type.startsWith('image/')) return;
                const reader = new FileReader();
                reader.onload = function() {
                    const dataUrl = reader.result;
                    try {
                        localStorage.setItem(AVATAR_STORAGE_KEY, dataUrl);
                        applyProfileAvatar();
                        if (typeof showNotification === 'function') showNotification('Avatar updated. It will appear in the sidebar on other pages.', 'success');
                    } catch (e) {
                        if (e.name === 'QuotaExceededError' && typeof showNotification === 'function')
                            showNotification('Image too large. Try a smaller file.', 'error');
                    }
                };
                reader.readAsDataURL(file);
                this.value = '';
            });
            if (removeBtn) {
                removeBtn.addEventListener('click', function() {
                    localStorage.removeItem(AVATAR_STORAGE_KEY);
                    applyProfileAvatar();
                    if (typeof showNotification === 'function') showNotification('Avatar removed.', 'success');
                });
            }
        }

        function setupRoleBasedSettings(user) {
            const name = user.name || [user.fname, user.lname].filter(Boolean).join(' ').trim();
            const initials = name ? name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2) : 'U';
            const profileInitials = document.getElementById('profile-initials');
            if (profileInitials) profileInitials.textContent = initials || 'U';

            if (user.role === 'teacher') {
                document.getElementById('teacher-bio')?.style.setProperty('display', 'block');
                document.getElementById('profile-visibility-desc').textContent = 'Make your profile visible to students';
            } else {
                document.getElementById('teacher-bio')?.style.setProperty('display', 'none');
                document.getElementById('profile-visibility-desc').textContent = 'Make your profile visible to other students';
            }
        }

        function applySavedPreferences() {
            try {
                const s = JSON.parse(localStorage.getItem('eel_settings') || '{}');
                if (s.privacy) {
                    const el = (id) => document.getElementById(id);
                    if (el('profile-visibility')) el('profile-visibility').checked = !!s.privacy.profileVisibility;
                    if (el('analytics')) el('analytics').checked = !!s.privacy.analytics;
                }
            } catch (e) {
                console.warn('Could not apply saved preferences:', e);
            }
        }

        async function loadProfileIntoForm(user) {
            const fn = document.getElementById('first-name');
            const ln = document.getElementById('last-name');
            const em = document.getElementById('email');
            if (!fn || !ln || !em) return;
            fn.value = user.fname ?? '';
            ln.value = user.lname ?? '';
            em.value = user.email ?? '';
            if (user.user_id) {
                try {
                    const res = await fetch(`${API_BASE}/users/me?user_id=${encodeURIComponent(user.user_id)}`);
                    if (res.ok) {
                        const data = await res.json();
                        if (data?.user) {
                            fn.value = data.user.fname ?? fn.value;
                            ln.value = data.user.lname ?? ln.value;
                            em.value = data.user.email ?? em.value;
                        }
                    }
                } catch (e) {
                    console.warn('Could not fetch profile:', e);
                }
            }
        }

        async function saveProfile() {
            const firstName = document.getElementById('first-name').value.trim();
            const lastName = document.getElementById('last-name').value.trim();
            const email = document.getElementById('email').value.trim();
            const user = window.currentUser;

            if (!firstName || !lastName || !email) {
                if (typeof showNotification === 'function') showNotification('Please fill in all required fields', 'warning');
                return;
            }
            if (!user?.user_id) {
                if (typeof showNotification === 'function') showNotification('Session expired. Please log in again.', 'error');
                return;
            }
            try {
                const res = await fetch(`${API_BASE}/users/me`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: user.user_id, fname: firstName, lname: lastName, email })
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) {
                    if (typeof showNotification === 'function') showNotification(data?.error || 'Failed to update profile', 'error');
                    return;
                }
                const u = JSON.parse(localStorage.getItem('eel_user') || '{}');
                u.fname = firstName;
                u.lname = lastName;
                u.email = email;
                localStorage.setItem('eel_user', JSON.stringify(u));
                window.currentUser = u;
                if (typeof showNotification === 'function') showNotification('Profile updated successfully!', 'success');
            } catch (err) {
                console.error(err);
                if (typeof showNotification === 'function') showNotification('Could not update profile. Try again.', 'error');
            }
        }

        function saveAllSettings() {
            const settings = {
                profile: {
                    firstName: document.getElementById('first-name')?.value,
                    lastName: document.getElementById('last-name')?.value,
                    email: document.getElementById('email')?.value,
                    bio: document.getElementById('bio')?.value
                },
                privacy: {
                    profileVisibility: document.getElementById('profile-visibility')?.checked,
                    analytics: document.getElementById('analytics')?.checked
                }
            };
            localStorage.setItem('eel_settings', JSON.stringify(settings));
            saveProfile().then(() => {
                if (typeof showNotification === 'function') showNotification('All settings saved successfully!', 'success');
            });
        }

        function changePassword() {
            document.getElementById('password-modal').classList.remove('hidden');
        }

        function closePasswordModal() {
            document.getElementById('password-modal').classList.add('hidden');
            // Clear password fields
            document.getElementById('current-password').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
        }

        async function updatePassword() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const user = window.currentUser;

            if (!currentPassword || !newPassword || !confirmPassword) {
                if (typeof showNotification === 'function') showNotification('Please fill in all password fields', 'warning');
                return;
            }
            if (newPassword !== confirmPassword) {
                if (typeof showNotification === 'function') showNotification('New passwords do not match', 'error');
                return;
            }
            if (newPassword.length < 8) {
                if (typeof showNotification === 'function') showNotification('Password must be at least 8 characters long', 'warning');
                return;
            }
            if (!user?.user_id) {
                if (typeof showNotification === 'function') showNotification('Session expired. Please log in again.', 'error');
                return;
            }
            try {
                const res = await fetch(`${API_BASE}/auth/change-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: user.user_id,
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) {
                    if (typeof showNotification === 'function') showNotification(data?.error || 'Failed to update password', 'error');
                    return;
                }
                closePasswordModal();
                if (typeof showNotification === 'function') showNotification('Password updated successfully!', 'success');
            } catch (err) {
                console.error(err);
                if (typeof showNotification === 'function') showNotification('Could not update password. Try again.', 'error');
            }
        }

        function exportData() {
            if (typeof showNotification === 'function') showNotification('Preparing data export...', 'info');
            const user = window.currentUser || {};
            const settings = (function() {
                try { return JSON.parse(localStorage.getItem('eel_settings') || '{}'); } catch { return {}; }
            })();
            const payload = {
                exportedAt: new Date().toISOString(),
                profile: {
                    user_id: user.user_id,
                    fname: user.fname,
                    lname: user.lname,
                    email: user.email,
                    role: user.role
                },
                preferences: settings
            };
            const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'EEL-MyData-' + (new Date().toISOString().slice(0, 10)) + '.json';
            a.click();
            URL.revokeObjectURL(a.href);
            if (typeof showNotification === 'function') showNotification('Data exported.', 'success');
        }

        function clearCache() {
            const keep = ['eel_user', 'eel_token'];
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) keys.push(localStorage.key(i));
            keys.forEach(k => { if (k && !keep.includes(k)) localStorage.removeItem(k); });
            if (typeof showNotification === 'function') showNotification('Cache cleared. You remain logged in.', 'success');
        }

        function replayTutorial() {
            localStorage.removeItem('eel_tutorial_done');
            window.location.href = 'classes.html';
        }

        function deleteAccount() {
            if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
                if (confirm('This will permanently delete all your data. Are you absolutely sure?')) {
                    if (typeof showNotification === 'function') showNotification('Account deletion is not available in-app. Contact your administrator.', 'warning');
                }
            }
        }
    </script>
</body>
</html>