<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recitation - EEL</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.css" rel="stylesheet">
    <script src="js/theme.js"></script>
</head>
<body class="recitation-page">
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>Loading Recitation...</p>
        </div>
    </div>

    <!-- Main Application Layout -->
    <div id="main-app" class="flex h-screen bg-background hidden">
        <!-- Sidebar -->
        <div id="sidebar" class="w-64 bg-sidebar border-r border-sidebar-border h-full flex flex-col">
            <!-- Sidebar Header -->
            <div class="p-6">
                <h1 id="sidebar-title" class="text-xl font-semibold">EEL</h1>
                <p id="sidebar-welcome" class="text-sm text-muted-foreground mt-1">Welcome</p>
            </div>
                        
            <!-- back to class Button -->
            <div class="p-4">
                <button id="back-class-btn" class="nav-button btn btn-side-bar w-full justify-start gap-3 p-3 rounded-md text-left transition-all flex items-center">
                    <i data-lucide="arrow-left" class="size-5"></i>
                    Back to Classes
                </button>
            </div>
            
            <!-- Navigation -->
            <nav id="sidebar-nav" class="flex-1 px-4 space-y-2">
                <!-- Navigation items will be populated by JavaScript -->
            </nav>

            <div class="p-4">
                <button id="logout-btn" class="w-full p-3 logout-button btn-side-bar border">
                    <i data-lucide="log-out"></i>
                    Logout
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <main id="main-content" class="flex-1 overflow-auto">
            <div class="recitation-main-wrap">
                <header class="recitation-page-header">
                    <img src="image/eel-character.png" alt="EEL mascot" class="page-header-character">
                    <div class="recitation-page-header-icon" aria-hidden="true">
                        <i data-lucide="mic" class="size-8"></i>
                    </div>
                    <div>
                        <h1 class="recitation-page-title">Interactive Recitation</h1>
                        <p class="recitation-page-subtitle">Choose a topic, set question types, then generate and start your session.</p>
                    </div>
                </header>

                <!-- Session Setup -->
                <div id="session-setup" class="content-view active recitation-setup">
                    <div class="recitation-setup-grid">
                        <section class="card recitation-card recitation-topic-card">
                            <div class="recitation-card-header">
                                <span class="recitation-card-icon" aria-hidden="true"><i data-lucide="book-open" class="size-5"></i></span>
                                <div>
                                    <h2 class="recitation-card-title">Select Topic</h2>
                                    <p class="recitation-card-desc">Pick a lesson topic (same list as Lessons)</p>
                                </div>
                            </div>
                            <div class="recitation-card-body">
                                <label class="form-label" for="recitation-topic">Topic</label>
                                <select id="recitation-topic" class="form-input recitation-select">
                                    <option value="">Select a topic</option>
                                </select>
                            </div>
                        </section>

                        <section class="card recitation-card recitation-config-card">
                            <div class="recitation-card-header">
                                <span class="recitation-card-icon" aria-hidden="true"><i data-lucide="settings" class="size-5"></i></span>
                                <div>
                                    <h2 class="recitation-card-title">Question Configuration</h2>
                                    <p class="recitation-card-desc">Same logic as Lessons: choose types and quantity per type, then generate with AI.</p>
                                </div>
                            </div>
                            <div class="recitation-card-body">
                                <div class="ai-quiz-types-quantity-wrap">
                                    <h4 class="ai-quiz-types-quantity-title">Question Types &amp; Quantity</h4>
                                    <div class="ai-quiz-types-quantity" role="group" aria-label="Question types and quantity">
                                        <label class="ai-quiz-type-qty-row">
                                            <input type="checkbox" name="recitation-quiz-type" class="ai-quiz-type-cb recitation-type-cb" value="multiple-choice">
                                            <span class="ai-quiz-type-qty-label">Multiple Choice</span>
                                            <input type="number" id="recitation-qty-multiple-choice" class="ai-quiz-type-qty-input" value="0" min="0" max="20" aria-label="Multiple choice questions">
                                            <span class="ai-quiz-type-qty-unit">questions</span>
                                        </label>
                                        <label class="ai-quiz-type-qty-row">
                                            <input type="checkbox" name="recitation-quiz-type" class="ai-quiz-type-cb recitation-type-cb" value="true-false">
                                            <span class="ai-quiz-type-qty-label">True or False</span>
                                            <input type="number" id="recitation-qty-true-false" class="ai-quiz-type-qty-input" value="0" min="0" max="20" aria-label="True or False questions">
                                            <span class="ai-quiz-type-qty-unit">questions</span>
                                        </label>
                                        <label class="ai-quiz-type-qty-row">
                                            <input type="checkbox" name="recitation-quiz-type" class="ai-quiz-type-cb recitation-type-cb" value="identification">
                                            <span class="ai-quiz-type-qty-label">Identification</span>
                                            <input type="number" id="recitation-qty-identification" class="ai-quiz-type-qty-input" value="0" min="0" max="20" aria-label="Identification questions">
                                            <span class="ai-quiz-type-qty-unit">questions</span>
                                        </label>
                                    </div>
                                </div>
                                <button type="button" id="generate-questions" class="btn btn-primary recitation-generate-btn ai-modal-generate-btn" disabled>
                                    <i data-lucide="brain" class="size-4"></i>
                                    Generate questions with AI
                                </button>
                            </div>
                        </section>
                    </div>

                    <div id="questions-generated" class="recitation-generated-summary hidden" aria-live="polite">
                        <i data-lucide="check-circle" class="size-5 text-primary"></i>
                        <span><strong id="question-count-text">0</strong> questions ready</span>
                    </div>

                    <div class="recitation-cta-wrap">
                        <button type="button" id="start-session" class="btn recitation-start-btn" onclick="startSession()" disabled>
                            <i data-lucide="play" class="size-5"></i>
                            Start recitation session
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Student Picker Modal ‚Äì wide, responsive, user-friendly -->
    <div id="student-picker" class="modal-overlay recitation-modal-overlay recitation-picker-overlay hidden" aria-modal="true" role="dialog" aria-labelledby="picker-heading">
        <div class="recitation-picker-card">
            <header class="recitation-picker-header">
                <div class="recitation-picker-header-text">
                    <h2 id="picker-heading" class="recitation-picker-heading">üéì Recitation Session</h2>
                    <p class="recitation-picker-sub">
                        Question <span id="current-question-num">1</span> of <span id="total-questions">10</span>
                    </p>
                </div>
                <button type="button" class="recitation-picker-close" onclick="backToSetup()" aria-label="Close">‚úï</button>
            </header>

            <div class="recitation-picker-body">
                <div class="recitation-picker-instruction">
                    <h3 class="recitation-picker-title">üéØ Pick a Student</h3>
                    <p class="recitation-picker-hint">Tap <strong>Play</strong> to randomly select a student, or tap a card to choose.</p>
                </div>

                <div class="recitation-slider-wrap">
                    <div id="student-slider" class="student-slider" role="list" aria-label="Students">
                        <!-- JS populates student cards here -->
                    </div>
                </div>
            </div>

            <footer class="recitation-picker-footer">
                <div class="recitation-picker-actions">
                    <button type="button" id="play-button" class="btn btn-primary recitation-play-btn" onclick="onPlayButtonClick()">
                        <span aria-hidden="true">‚ñ∂Ô∏è</span> <span id="play-btn-text">Play</span>
                    </button>
                    <label class="recitation-picker-auto-label">
                        <input type="checkbox" id="auto-pick-toggle" class="recitation-picker-auto-cb"> <span>Auto pick</span>
                    </label>
                </div>
                <p class="recitation-picker-remaining">
                    <span id="students-remaining" class="recitation-picker-remaining-num">10</span> students remaining
                </p>
            </footer>
        </div>
    </div>


    <!-- Question Modal: compact, readable layout that fits laptop (1366√ó768) -->
    <div id="question-modal" class="modal-overlay recitation-modal-overlay hidden">
        <div class="modal-card recitation-modal-card recitation-question-card">
            <header class="modal-header recitation-modal-header recitation-question-header">
                <div class="recitation-question-header-inner">
                    <h3 class="recitation-question-title">
                        <span id="modal-student-name" class="recitation-student-name"></span>
                    </h3>
                    <div class="recitation-question-meta-row">
                        <span class="recitation-question-progress">
                            <span id="modal-question-num">1</span> of <span id="modal-total-questions">10</span>
                        </span>
                        <span id="modal-question-type" class="recitation-question-type-badge"></span>
                    </div>
                </div>
                <button type="button" class="close-btn recitation-close-btn" onclick="closeQuestionModal()" aria-label="Close">‚úñ</button>
            </header>

            <div class="recitation-modal-content recitation-question-content">
                <div id="question-timer" class="recitation-question-timer" aria-live="polite">‚è∞ 20s left</div>
                <section class="recitation-question-block" aria-label="Question">
                    <p id="modal-question-text" class="recitation-question-text"></p>
                </section>

                <section id="answer-section" class="recitation-answer-section" aria-label="Your answer">
                    <label class="recitation-answer-label">Your answer</label>
                    <div id="answer-input-container" class="recitation-answer-input-container"></div>
                </section>

                <section id="result-section" class="result-section recitation-result-section hidden" aria-label="Result">
                    <div id="result-content" class="recitation-result-content"></div>
                </section>
            </div>

            <footer class="modal-footer recitation-modal-footer recitation-question-footer">
                <div id="modal-actions" class="recitation-footer-actions">
                    <button type="button" class="btn btn-outline" onclick="closeQuestionModal()">
                        <i data-lucide="x" class="size-4 mr-1"></i> Cancel
                    </button>
                    <button type="button" class="btn btn-primary" onclick="submitAnswer()">
                        <i data-lucide="send" class="size-4 mr-1"></i> Submit
                    </button>
                </div>
                <button type="button" id="continue-button" class="btn btn-primary recitation-continue-btn hidden" onclick="continueToNext()">
                    <i data-lucide="arrow-right" class="size-4 mr-1"></i> Next Student
                </button>
            </footer>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="js/auth.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="js/navigation.js"></script>
    <script src="js-front-end/front-recitation.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const classId = urlParams.get('class_id');
                if (classId) {
                    localStorage.setItem("eel_selected_class_id", classId);
                    const newUrl = window.location.origin + window.location.pathname;
                    window.history.replaceState({}, document.title, newUrl);
                }
                await initializePage();
                hideLoading();
                if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
            } catch (e) {
                console.error("Failed to initialize recitation page:", e);
                try { hideLoading(); } catch (_) {}
            }
        });
    </script>
</body>
</html>